<div class="details-container pb-8">
    @if (vm$ | async; as vm) {
        <section class="hero">
            @if (mediaStoreService.backdrop$ | async; as backdrop) {
                <app-media-thumb
                    class="hero__backdrop"
                    [alt]="vm.title"
                    [src]="backdrop"
                    [params]="'w1920_and_h800_multi_faces'"
                ></app-media-thumb>
                <div class="hero__gradient"></div>
            }

            <div class="hero__content inner-container">
                <app-media-thumb
                    class="hero__poster border-round-xl"
                    [src]="vm.posterPath"
                    type="media"
                    [alt]="vm.title"
                />
                <div class="hero__info">
                    <h1 class="hero__title">{{ vm.title }}</h1>
                    <p class="hero__year">{{ vm.year }}</p>

                    @if (vm.voteAverage) {
                        <div class="flex align-items-center gap-3 mt-2">
                            <app-rating [value]="vm.voteAverage" />
                            @if (vm.runtime) {
                                <span class="muted">{{
                                    vm.runtime | m2h
                                }}</span>
                            }
                        </div>
                    }

                    <div class="flex flex-wrap gap-2 mt-2">
                        @for (genre of vm.genres; track genre.id) {
                            <mat-chip
                                [routerLink]="['/discover']"
                                [queryParams]="{
                                    withGenres: genre.id,
                                    type: vm.mediaType,
                                }"
                            >
                                {{ genre.name }}
                            </mat-chip>
                        }
                    </div>

                    <p class="hero__overview line-height-4 mt-2 mb-3">
                        {{ vm.overview }}
                    </p>

                    <app-social-links
                        [links]="mediaStoreService.socialLinks$ | async"
                        [item]="mediaStoreService.media$ | async"
                    />
                </div>
            </div>
        </section>

        <div class="inner-container mt-4 flex flex-column gap-6">
            @if ((mediaStoreService.cast$ | async)?.length) {
                <section class="cast-section">
                    <h2 class="section-title">Top Cast</h2>
                    <app-carousel
                        [items]="(mediaStoreService.cast$ | async)!"
                        [numVisible]="6"
                        [numScroll]="6"
                    >
                        <ng-template let-person>
                            <app-person-card [person]="person" />
                        </ng-template>
                    </app-carousel>

                    <div class="crew-rows">
                        @if (
                            mediaStoreService.directors$ | async;
                            as directors
                        ) {
                            @if (directors.length) {
                                <div class="crew-row">
                                    <span class="crew-row-label"
                                        >Director{{
                                            directors.length > 1 ? "s" : ""
                                        }}</span
                                    >
                                    <span class="crew-row-names">
                                        @for (
                                            person of directors;
                                            track person.id;
                                            let i = $index
                                        ) {
                                            <a
                                                class="crew-row-link"
                                                [routerLink]="[
                                                    '/name',
                                                    person.id,
                                                ]"
                                                >{{ person.name }}</a
                                            >
                                            @if (i < directors.length - 1) {
                                                <span class="crew-row-sep"
                                                    >·</span
                                                >
                                            }
                                        }
                                    </span>
                                </div>
                            }
                        }
                        @if (vm.creators?.length) {
                            <div class="crew-row">
                                <span class="crew-row-label"
                                    >Creator{{
                                        vm.creators!.length > 1 ? "s" : ""
                                    }}</span
                                >
                                <span class="crew-row-names">
                                    @for (
                                        creator of vm.creators;
                                        track creator.id;
                                        let i = $index
                                    ) {
                                        <a
                                            class="crew-row-link"
                                            [routerLink]="['/name', creator.id]"
                                            >{{ creator.name }}</a
                                        >
                                        @if (i < vm.creators!.length - 1) {
                                            <span class="crew-row-sep">·</span>
                                        }
                                    }
                                </span>
                            </div>
                        }
                        <a
                            class="crew-row crew-row-all"
                            [routerLink]="['cast']"
                        >
                            <span class="crew-row-label">All cast & crew</span>
                            <i
                                class="fa-solid fa-chevron-right crew-row-chevron"
                            ></i>
                        </a>
                    </div>
                </section>
            }

            @if (vm.mediaType === "tv") {
                <section class="episodes-section">
                    <div
                        class="flex align-items-center justify-content-between mb-3"
                    >
                        <div>
                            <h2 class="section-title m-0">Episodes</h2>
                            @if (
                                mediaStoreService.latestSeason$ | async;
                                as latest
                            ) {
                                <span class="muted text-sm">{{
                                    latest.name
                                }}</span>
                            }
                        </div>
                        <a
                            class="browse-episodes-link"
                            [routerLink]="['episodes']"
                        >
                            Browse all episodes
                            <i class="fa-solid fa-chevron-right"></i>
                        </a>
                    </div>

                    <div class="episode-preview-list">
                        @for (
                            episode of mediaStoreService.latestSeasonPreviewEpisodes$
                                | async;
                            track episode.id
                        ) {
                            <a
                                class="episode-preview-card"
                                [routerLink]="[
                                    'episodes',
                                    episode.season_number,
                                    episode.episode_number,
                                ]"
                            >
                                <app-media-thumb
                                    class="episode-preview-still"
                                    [src]="episode.still_path ?? null"
                                />
                                <div class="episode-preview-meta">
                                    <span class="episode-preview-label">
                                        S{{ episode.season_number }}E{{
                                            episode.episode_number
                                        }}
                                    </span>
                                    <span class="episode-preview-title">{{
                                        episode.name
                                    }}</span>
                                    <p class="episode-preview-overview">
                                        {{ episode.overview }}
                                    </p>
                                    <span class="muted text-sm">{{
                                        episode.air_date | date
                                    }}</span>
                                </div>
                            </a>
                        }
                    </div>
                </section>
            }

            @if (mediaStoreService.featuredVideos$ | async; as featured) {
                @if (featured.length) {
                    <section class="videos-section">
                        <div
                            class="flex align-items-center justify-content-between mb-3"
                        >
                            <h2 class="section-title m-0">
                                Videos
                                <span class="section-count">{{
                                    mediaStoreService.youtubeVideosTotalCount$
                                        | async
                                }}</span>
                            </h2>
                            <a
                                class="browse-episodes-link"
                                [routerLink]="['videos']"
                            >
                                Browse all videos
                                <i class="fa-solid fa-chevron-right"></i>
                            </a>
                        </div>

                        <div class="videos-featured">
                            @for (video of featured; track video.id) {
                                <a
                                    class="video-thumb"
                                    [href]="getYoutubeUrl(video.key!)"
                                    target="_blank"
                                    rel="noopener"
                                >
                                    <div class="video-thumb__img">
                                        <img
                                            [src]="
                                                getYoutubeThumbnail(video.key!)
                                            "
                                            [alt]="video.name"
                                        />
                                        <div class="video-thumb__play">
                                            <i class="fa-solid fa-play"></i>
                                        </div>
                                        @if (video.type) {
                                            <span class="video-thumb__badge">{{
                                                video.type
                                            }}</span>
                                        }
                                    </div>
                                    <p class="video-thumb__name">
                                        {{ video.name }}
                                    </p>
                                </a>
                            }
                        </div>

                        @if (mediaStoreService.gridVideos$ | async; as grid) {
                            @if (grid.length) {
                                <div class="videos-grid">
                                    @for (
                                        video of grid;
                                        track video.id;
                                        let last = $last
                                    ) {
                                        @if (
                                            last &&
                                            (mediaStoreService.youtubeVideosTotalCount$
                                                | async)! > 6
                                        ) {
                                            <a
                                                class="video-thumb"
                                                [routerLink]="['videos']"
                                            >
                                                <div class="video-thumb__img">
                                                    <img
                                                        [src]="
                                                            getYoutubeThumbnail(
                                                                video.key!
                                                            )
                                                        "
                                                        [alt]="video.name"
                                                    />
                                                    <div
                                                        class="video-thumb__more"
                                                    >
                                                        +{{
                                                            (mediaStoreService.youtubeVideosTotalCount$
                                                                | async)! - 5
                                                        }}
                                                    </div>
                                                </div>
                                            </a>
                                        } @else {
                                            <a
                                                class="video-thumb"
                                                [href]="
                                                    getYoutubeUrl(video.key!)
                                                "
                                                target="_blank"
                                                rel="noopener"
                                            >
                                                <div class="video-thumb__img">
                                                    <img
                                                        [src]="
                                                            getYoutubeThumbnail(
                                                                video.key!
                                                            )
                                                        "
                                                        [alt]="video.name"
                                                    />
                                                    <div
                                                        class="video-thumb__play video-thumb__play--sm"
                                                    >
                                                        <i
                                                            class="fa-solid fa-play"
                                                        ></i>
                                                    </div>
                                                    @if (video.type) {
                                                        <span
                                                            class="video-thumb__badge"
                                                            >{{
                                                                video.type
                                                            }}</span
                                                        >
                                                    }
                                                </div>
                                                <p class="video-thumb__name">
                                                    {{ video.name }}
                                                </p>
                                            </a>
                                        }
                                    }
                                </div>
                            }
                        }
                    </section>
                }
            }
            @if (mediaStoreService.featuredBackdrops$ | async; as photos) {
                @if (photos.length) {
                    <section class="photos-section">
                        <h2 class="section-title">
                            Photos
                            <span class="section-count">{{
                                mediaStoreService.backdropsTotalCount$ | async
                            }}</span>
                        </h2>
                        <app-photos-grid
                            [images]="photos"
                            [totalCount]="
                                (mediaStoreService.backdropsTotalCount$
                                    | async)!
                            "
                            aspectRatio="16 / 9"
                            (photoClick)="openPhotoViewer($event)"
                        />
                    </section>
                }
            }

            @if ((mediaStoreService.recommendations$ | async)?.length) {
                <section class="recommendations-section">
                    <h2 class="section-title">More Like This</h2>
                    <app-carousel
                        [items]="
                            (mediaStoreService.recommendations$ | async)!
                                | sort: 'vote_average'
                        "
                        [numVisible]="8"
                        [numScroll]="8"
                    >
                        <ng-template let-media>
                            <app-card [item]="media" />
                        </ng-template>
                    </app-carousel>
                </section>
            }
            <section class="details-section">
                <h2 class="section-title">Details</h2>
                <ul class="details-list list-none pl-0 m-0">
                    @if (vm.releaseDate) {
                        <li class="details-row">
                            <span class="details-label">Released</span>
                            <span>{{ vm.releaseDate | date }}</span>
                        </li>
                    }

                    @if (vm.firstAirDate) {
                        <li class="details-row">
                            <span class="details-label">First Aired</span>
                            <span>{{ vm.firstAirDate | date }}</span>
                        </li>
                    }

                    @if (vm.lastAirDate) {
                        <li class="details-row">
                            <span class="details-label">Last Aired</span>
                            <span>{{ vm.lastAirDate | date }}</span>
                        </li>
                    }

                    @if (vm.runtime) {
                        <li class="details-row">
                            <span class="details-label">Runtime</span>
                            <span>{{ vm.runtime | m2h }}</span>
                        </li>
                    }

                    @if (vm.budget) {
                        <li class="details-row">
                            <span class="details-label">Budget</span>
                            <span>${{ vm.budget | number }}</span>
                        </li>
                    }

                    @if (vm.revenue) {
                        <li class="details-row">
                            <span class="details-label">Revenue</span>
                            <span>${{ vm.revenue | number }}</span>
                        </li>
                    }

                    @if (vm.numberOfSeasons) {
                        <li class="details-row">
                            <span class="details-label">Seasons</span>
                            <span>{{ vm.numberOfSeasons }}</span>
                        </li>
                    }

                    @if (vm.numberOfEpisodes) {
                        <li class="details-row">
                            <span class="details-label">Episodes</span>
                            <span>{{ vm.numberOfEpisodes }}</span>
                        </li>
                    }

                    @if (vm.status) {
                        <li class="details-row">
                            <span class="details-label">Status</span>
                            <span>{{ vm.status }}</span>
                        </li>
                    }

                    @if (vm.languages.length) {
                        <li class="details-row">
                            <span class="details-label">Languages</span>
                            <span>{{ vm.languages.join(", ") }}</span>
                        </li>
                    }

                    @if (vm.networks?.length) {
                        <li class="details-row">
                            <span class="details-label">Networks</span>
                            <span>
                                @for (
                                    network of vm.networks;
                                    track network.id;
                                    let i = $index
                                ) {
                                    {{ network.name }}
                                    @if (i !== vm.networks!.length - 1) {
                                        <span>, </span>
                                    }
                                }
                            </span>
                        </li>
                    }
                </ul>
            </section>
        </div>
    }
</div>
