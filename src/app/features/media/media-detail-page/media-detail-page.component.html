<div
  class="h-full details-container pb-4"
  [class.mobile]="globalStore.isMobile()"
>
  <div class="relative">
    @if (mediaStoreService.hasBackdrop$ | async) {
      <img
        [src]="
          (mediaStoreService.backdrop$ | async) || ''
            | imgSrc: 'w1920_and_h800_multi_faces'
        "
        class="backdrop-image"
      />
    }
    <div class="gradient-cover"></div>
  </div>
  <div
    class="relative info-container md:ml-auto md:mr-auto md:px-8 px-4 w-full"
    [class.mt-0]="(mediaStoreService.hasBackdrop$ | async) === false"
    [class.pt-4]="(mediaStoreService.hasBackdrop$ | async) === false"
    [style.maxWidth.px]="1400"
  >
    <div
      class="flex md:flex-row flex-column"
      *ngIf="mediaItem$ | async as item"
    >
      <div class="">
        <img
          src="{{ item.poster_path | imgSrc: 'w500' }}"
          class="poster-image border-round-lg"
        />
        <div class="mt-4 mb-3">
          <app-social-links
            [links]="mediaStoreService.socialLinks$ | async"
            [item]="item"
          ></app-social-links>
        </div>
      </div>
      <div class="flex flex-column mt-2 md:mt-8 gap-2 md:ml-6">
        <h1 class="m-0">{{ item.title || item.name }}</h1>
        <p class="m-0">
          {{ item.release_date || item.first_air_date | date: "yyyy" }}
        </p>
        <div class="flex flex-row gap-2">
          <p-rating
            [ngModel]="item.vote_average / 2"
            [readonly]="true"
          ></p-rating>
          <span>{{ item.vote_average | number: "1.1-1" }}/10</span>
        </div>
        <div class="flex flex-row mt-2 gap-2 flex-wrap">
          @for (genre of item.genres; track genre.id) {
            <p-chip styleClass="cursor-pointer genre">
              <a
                [routerLink]="['/discover', mediaType$ | async]"
                [queryParams]="{ with_genres: genre.id }"
                >{{ genre.name }}</a
              ></p-chip
            >
          }
        </div>
        <p class="mt-2 mb-0 line-height-4" [style.maxWidth.px]="550">
          {{ item.overview }}
        </p>
        <ul class="media-info-list">
          <li *ngIf="item.first_air_date">
            <div class="media-info-label">First Aired</div>
            <div class="flex-1">{{ item.first_air_date | date }}</div>
          </li>
          <li *ngIf="item.last_air_date">
            <div class="media-info-label">Last Aired</div>
            <div class="flex-1">{{ item.last_air_date | date }}</div>
          </li>
          <li *ngIf="item.release_date">
            <div class="media-info-label">Released</div>
            <div class="flex-1">{{ item.release_date | date }}</div>
          </li>
          <li *ngIf="item.runtime">
            <div class="media-info-label">Runtime</div>
            <div class="flex-1">{{ item.runtime | m2h }}</div>
          </li>
          <li *ngIf="item.budget">
            <div class="media-info-label">Budget</div>
            <div class="flex-1">${{ item.budget | number }}</div>
          </li>
          <li *ngIf="item.revenue">
            <div class="media-info-label">Revenue</div>
            <div class="flex-1">${{ item.revenue | number }}</div>
          </li>
          <li *ngIf="item.created_by?.length">
            <div class="media-info-label">Creator</div>
            <div class="flex-1">
              @for (
                creator of item.created_by;
                track creator.id;
                let i = $index
              ) {
                <span
                  class="cursor-pointer"
                  [routerLink]="['/people', creator.id]"
                  >{{ creator.name }}</span
                >
                <span *ngIf="i !== item.created_by.length - 1">, </span>
              }
            </div>
          </li>
          <li *ngIf="item.number_of_seasons">
            <div class="media-info-label">Seasons</div>
            <div class="flex-1">{{ item.number_of_seasons }}</div>
          </li>
          <li *ngIf="item.number_of_episodes">
            <div class="media-info-label">Episodes</div>
            <div class="flex-1">{{ item.number_of_episodes }}</div>
          </li>
          <li *ngIf="item.status">
            <div class="media-info-label">Status</div>
            <div class="flex-1">{{ item.status }}</div>
          </li>
          <li *ngIf="(languages$ | async)?.length > 0">
            <div class="media-info-label">Languages</div>
            <div class="flex-1">
              @for (
                lang of languages$ | async;
                track lang.name;
                let i = $index
              ) {
                <span>{{ lang.english_name }}</span>
                <span *ngIf="i !== (languages$ | async)?.length - 1">, </span>
              }
            </div>
          </li>
          <li *ngIf="item.networks?.length">
            <div class="media-info-label">Networks</div>
            <div class="flex-1">
              @for (
                network of item.networks;
                track network.id;
                let i = $index
              ) {
                <span>{{ network.name }}</span>
                <span *ngIf="i !== item.networks.length - 1">, </span>
              }
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div
    class="tab-content md:ml-auto md:mr-auto md:px-8 px-4 mt-4"
    [style.maxWidth.px]="1400"
  >
    @if ((mediaStoreService.cast$ | async)?.length) {
      <div class="detail-section">
        <h2 class="section-title mb-3">Cast</h2>
        <p-carousel
          [value]="mediaStoreService.cast$ | async"
          [numVisible]="6"
          [numScroll]="6"
          [showIndicators]="false"
          [responsiveOptions]="breakpoints"
        >
          <ng-template let-person pTemplate="item">
            <app-person-card [person]="person"></app-person-card>
          </ng-template>
        </p-carousel>
      </div>
    }

    @if (
      (mediaType$ | async) === "tv" &&
      (mediaStoreService.seasons$ | async)?.length
    ) {
      <div class="detail-section">
        <h2 class="section-title mb-3">Episodes</h2>
        <div class="flex flex-row py-4 mx-2 align-items-center">
          <div>
            <label for="seasons" class="mr-2">Seasons</label>
            <p-select
              optionLabel="name"
              optionValue="season_number"
              id="seasons"
              [ngModel]="mediaStoreService.selectedSeason$ | async"
              [options]="mediaStoreService.seasons$ | async"
              [disabled]="(mediaStoreService.seasons$ | async)?.length === 1"
              (ngModelChange)="changeSeason($event)"
            ></p-select>
            @if (
              mediaStoreService.seasonEpisodesCount$ | async;
              as episodeCount
            ) {
              <strong class="muted md:px-4 px-2"
                >{{ episodeCount }} Episodes</strong
              >
            }
          </div>
        </div>

        <div class="grid m-0">
          @for (
            episode of mediaStoreService.seasonEpisodes$ | async;
            track episode.id
          ) {
            <div class="col-12 sm:col-6 md:col-4 lg:col-3 p-0">
              <div class="episode-item">
                @if (episode.still_path) {
                  <img src="{{ episode.still_path | imgSrc }}" />
                } @else {
                  <img src="assets/empty_still.svg" />
                }
                <div class="episode-content">
                  <h2 class="name mb-2">
                    <strong class="mr-2">E{{ episode.episode_number }}</strong
                    >{{ episode.name }}
                  </h2>
                  <div class="episode-overview mb-2">
                    {{ episode.overview }}
                  </div>
                  <div class="muted">{{ episode.air_date | date }}</div>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    @if ((videos$ | async)?.length) {
      <div class="detail-section">
        <h2 class="section-title mb-3">Videos</h2>
        <div class="flex flex-row gap-3 overflow-y-hidden overflow-x-auto pb-2">
          @for (video of videos$ | async; track video.id) {
            <div class="video-frame">
              <iframe
                [src]="video | yt"
                title="{{ video.name }}"
                frameborder="0"
                allowedfullscreen
                class="iframe"
              ></iframe>
            </div>
          }
        </div>
      </div>
    }

    @if (mediaStoreService.backdropCount$ | async; as count) {
      <div class="detail-section">
        <div class="section-header mb-3">
          <h2 class="section-title">Backdrops</h2>
          <span class="view-all-btn" (click)="openGalleria(allBackdrops)">
            View All ({{ count }})
            <i class="fa-solid fa-images"></i>
          </span>
        </div>
        <div
          class="flex flex-wrap gap-3 justify-content-center md:justify-content-start"
        >
          @for (
            image of mediaStoreService.backdropPreviews$ | async;
            track image.file_path;
            let i = $index
          ) {
            <img
              class="backdrop-photo cursor-pointer"
              src="{{ image.file_path | imgSrc }}"
              (click)="openGalleria(allBackdrops, i)"
            />
          }
        </div>
      </div>
    }
    @if (mediaStoreService.posterCount$ | async; as count) {
      <div class="detail-section">
        <div class="section-header mb-3">
          <h2 class="section-title">Posters</h2>
          <span class="view-all-btn" (click)="openGalleria(allPosters)">
            View All ({{ count }})
            <i class="fa-solid fa-images"></i>
          </span>
        </div>
        <div
          class="flex flex-wrap gap-3 justify-content-center md:justify-content-start"
        >
          @for (
            image of mediaStoreService.posterPreviews$ | async;
            track image.file_path;
            let i = $index
          ) {
            <img
              class="poster-photo cursor-pointer"
              src="{{ image.file_path | imgSrc }}"
              (click)="openGalleria(allPosters, i)"
            />
          }
        </div>
      </div>
    }

    <div
      *ngIf="(mediaStoreService.recommendations$ | async)?.length"
      class="detail-section"
    >
      <h2 class="section-title mb-3">More Like This</h2>
      <p-carousel
        [value]="
          (mediaStoreService.recommendations$ | async)! | sort: 'vote_average'
        "
        [numVisible]="6"
        [numScroll]="6"
        [showIndicators]="false"
        [responsiveOptions]="breakpoints"
      >
        <ng-template let-media pTemplate="item">
          <app-card [item]="media"></app-card>
        </ng-template>
      </p-carousel>
    </div>
  </div>
</div>

<p-galleria
  [(value)]="galleriaImages"
  [visible]="galleriaVisible"
  (visibleChange)="onGalleriaClose()"
  [(activeIndex)]="galleriaActiveIndex"
  [fullScreen]="true"
  [showThumbnails]="!globalStore.isMobile()"
  [showItemNavigators]="true"
  [circular]="true"
  [numVisible]="7"
  [responsiveOptions]="[
    { breakpoint: '768px', numVisible: 5 },
    { breakpoint: '480px', numVisible: 3 },
  ]"
>
  <ng-template pTemplate="item" let-item>
    <img [src]="item.source" class="galleria-main-image" />
  </ng-template>
  <ng-template pTemplate="thumbnail" let-item>
    <img [src]="item.thumbnail" class="galleria-thumbnail" />
  </ng-template>
</p-galleria>
